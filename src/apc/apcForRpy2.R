library('RJSONIO');
library('stringr');
# Use These directories when testing locally running a Flask Server
#source ('~/myproject/nci-analysis-tools-web-presence/src/apc/apcLatest.R')
#source ('~/myproject/nci-analysis-tools-web-presence/src/apc/writeToExcel.R')

# Use these directories in production
source ('apcLatest.R');
source ('writeToExcel.R')

# Use These directories when testing locally running a Flask Server
#imageDirectory <- "/home/brent/myproject/nci-analysis-tools-web-presence/src/apc/static/img/";
#rawDirectory <- "/home/brent/myproject/nci-analysis-tools-web-presence/src/apc/static/raw/";

# Use these directories in production
imageDirectory <- "static/img/";
rawDirectory <- "static/raw/";

moveRowLabelsToData <- function (matrixWithNamedRows, key) {
  
  # For some unknown reason the special character (e.g. ' ', '-') being passed in the matrix column names
  # are converted to '.'  in the above conversion to a data.frame and this causes
  # all kinds of problems in the javascript later so I am hard coding the column names because
  # I don't have the time to clean this up and I can't change the apcLatest.R code to pass me a data frame
  # begin with.
  
  if ( key == "Coefficients") {
    dataNoRowNames <- data.frame(row.names(matrixWithNamedRows),round(matrixWithNamedRows,3), row.names = NULL);

    colnames(dataNoRowNames)<- c(' ', "Parameter", "SD", "CI Lo", "CI Hi");
    # This is ugly but I can't figure out how to make this work in another way. I want a vector of List for
    # each row in the dataframe. If someone can think of a better way that would be great.
    row1 <- list(dataNoRowNames[1,]);
    row2 <- list(dataNoRowNames[2,]);
    row3 <- list(dataNoRowNames[3,]);
    row4 <- list(dataNoRowNames[4,]);
    returnValue <- c(row1,row2, row3, row4);
  } else {
    dataNoRowNames <- data.frame(row.names(matrixWithNamedRows),matrixWithNamedRows, row.names = NULL);
    dataNoRowNames[,4]<-formatC(round(dataNoRowNames[,4], 5), format="fg");
    #print (dataNoRowNames[,4]);
    dataNoRowNames[,2]<-round(dataNoRowNames[,2], 3);
    colnames(dataNoRowNames)<- c(' ', 'X2', 'df', 'P-Value');

    row1 <- list(dataNoRowNames[1,]);
    row2 <- list(dataNoRowNames[2,]);
    row3 <- list(dataNoRowNames[3,]);
    row4 <- list(dataNoRowNames[4,]);
    row5 <- list(dataNoRowNames[5,]);
    row6 <- list(dataNoRowNames[6,]);
    row7 <- list(dataNoRowNames[7,]);
    returnValue <- c(row1,row2, row3, row4, row5, row6, row7);
  }
  returnValue
}

parseURLEncodedString <- function (urlEncodedString) {
  #print (urlEncodedString);
  string <- URLdecode(urlEncodedString);
  inputList <- lapply(strsplit(string, "&")[[1]], function(x){
    tmp <- strsplit(x, "=")
    val <- tmp[[1]][[2]]
    names(val) <- tmp[[1]][[1]]
    as.list(val)
  });
}

getKey <- function (inputList) {
  inputList[[1]][[1]];  
}

getTitle <- function (inputList) {
  inputList[[2]][[1]];
}

getStartYear <- function (inputList) {
  inputList[[3]][[1]];
}

getStartAge <- function (inputList) {
  inputList[[4]][[1]];
}

getInterval <- function (inputList) {
  inputList[[5]][[1]];
}

getPeriods <- function (inputList) {
  inputList[[6]][[1]];
}

getRowCount <- function (inputList) {
  inputList[[7]][[1]];
}

getCountData <- function(inputList) {  
  inputList[[8]][[1]];
}

getPopulationData <- function (inputList) {
  inputList[[9]][[1]];
}

getUniqueId <- function(inputList) {
  inputList[[10]][[1]];  
}

getDescription <- function(inputList) {
  inputList[[11]][[1]];  
}

createPanCanList <- function (inputList) {
 
  startYear <- as.numeric(getStartYear(inputList));
  startAge <- as.numeric(getStartAge(inputList));
  periods <- as.numeric(getPeriods(inputList));
  rowCount <- as.numeric(getRowCount(inputList));
  countCSV <-getCountData(inputList);
  populationCSV <- getPopulationData(inputList);
  
  interval <- switch(getInterval(inputList), year1 = 1, year2 = 2, year3 = 3, year4 = 4, year5 = 5, year6 = 6, year7 = 7, year8 = 8, year9 = 9, year10 = 10);
  panCan <- list(name = URLdecode(getTitle(inputList)),
                 description = getDescription(inputList),
                 # events = to Count Columns in APC Spread Sheet
                 events =  matrix(c(as.numeric(strsplit(countCSV,',')[[1]])), ncol = periods, nrow = rowCount, byrow=TRUE), 
                 # offset = to Population Columns in APC Spread Sheet
                 offset = matrix(c(as.numeric(strsplit(populationCSV,',')[[1]])), ncol = periods, nrow = rowCount, byrow=TRUE), 
                 offset_tick = 100000,
                 # age one more than total Rows,
                 ages = seq(startAge, ((rowCount*interval)+(startAge)), by = interval), 
                 # periods one more than tot Col
                 periods = seq(startYear, ((periods*interval)+(startYear)), by = interval) 
  );
  panCan;
}

getGraph <- function (apcOutput, keyGraphName, uniqueId) {
  imageFileName = paste(imageDirectory, keyGraphName, uniqueId, ".png", sep = '');
  png(file = imageFileName , units="in", width=10, height=8, res=150);
  line.apc(apcOutput, keyGraphName);
  dev.off();
  imageFileName;
}

getApcData <- function (urlEncodedString) {
  apcdata<-apc(createPanCanList (urlEncodedString));
}

getApcDataJSON <-function(urlEncodedString)
{
  inputList <- parseURLEncodedString(urlEncodedString);
  apcdata<-getApcData (inputList);
  jsonString = "";
  key <- getKey(inputList);
  uniqueId <- getUniqueId(inputList);
  
  if (key == "AgeDeviations") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$AgeDeviations,3), method="C");
  } else if (key == "PerDeviations") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$PerDeviations,3), method="C");
  } else if (key == "CohDeviations") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$CohDeviations,3), method="C");
  } else if (key == "LongAge") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$LongAge,3), method="C");
  } else if (key == "CrossAge") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$CrossAge,3), method="C");
  } else if (key == "Long2CrossRR") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$Long2CrossRR,3), method="C");
  } else if (key == "FittedTemporalTrends") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$FittedTemporalTrends,3), method="C");
  } else if (key == "PeriodRR") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$PeriodRR,3), method="C");
  } else if (key == "CohortRR") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$CohortRR,3), method="C");
  } else if (key == "LocalDrifts") {
    getGraph(apcdata, key, uniqueId);
    jsonString <- toJSON(round(apcdata$LocalDrifts,3), method="C");
  } else if (key == "Coefficients") {
    coefficients <- moveRowLabelsToData(apcdata$Coefficients, key);
    jsonString <- toJSON(coefficients, method="C", );
  } else if (key == "Waldtests") {
    waldtests <- moveRowLabelsToData(apcdata$Waldtests, key);
    jsonString <- toJSON(waldtests, method="C");
    #print(jsonString);
  } else if (key == "NetDrift") {
    jsonString <- toJSON(round(apcdata$NetDrift,3), method="C");
  } else if (key =="Offset") {
    jsonString <- toJSON(apcdata$FittedRates$offset_tick, method="C");
  } else if (key =="RawData") {
    # Redudant, I know but can't rewrite at this stage of the project
    inputData <-createPanCanList (parseURLEncodedString(urlEncodedString)); 
    
    time <- gsub(":","",gsub("-","",gsub(" ","", Sys.time() , fixed=TRUE)));
    title <- gsub(" ", "", gsub("[[:punct:]]", "", inputData$name));

    defaultTitle<-pmatch("APCAnalysis", title, nomatch=0);

    if (defaultTitle > 0) {
      rawInputDataFileName <- paste(rawDirectory, title,"_","RawInput.RData", sep='');
      rawOutputDataFileName <- paste(rawDirectory,title,"_","RawOutput.RData", sep='');
      txtInputDataFileName <- paste(rawDirectory, title,"_","RawInput.txt", sep='');
      txtOutputDataFileName <- paste(rawDirectory, title,"_","RawOutput.txt", sep='');  
    } else {
      rawInputDataFileName <- paste(rawDirectory, title,"_",time,"_","RawInput.RData", sep='');
      rawOutputDataFileName <- paste(rawDirectory, title,"_",time,"_","RawOutput.RData", sep='');
      txtInputDataFileName <- paste(rawDirectory, title,"_",time,"_","RawInput.txt", sep='');
      txtOutputDataFileName <- paste(rawDirectory, title,"_",time,"_","RawOutput.txt", sep='');
    }
    save(inputData, file = rawInputDataFileName);
    save(apcdata, file = rawOutputDataFileName);
    
    capture.output(print(inputData), file=txtInputDataFileName);
    capture.output(print(apcdata), file=txtOutputDataFileName);
    
    jsonString <- toJSON(c(rawInputDataFileName, rawOutputDataFileName, txtInputDataFileName, txtOutputDataFileName));
  }else if(key == "Excel") {
    # Assumes the graphs have already been created and just need to be added to Excel
    # Therefore, all other keys above must have been called for this to work.
    
    excelFileName <- writeResultsToExcel(apcdata, uniqueId, URLdecode(getTitle(inputList)), imageDirectory);
    jsonString <- toJSON(excelFileName);
  }
  str_replace_all(jsonString, "[\n]","");
  

}

# Call from Python....
# This one has different data for testing Scientific notation of Wald Tests
#getApcDataJSON("key=Waldtests&title=Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=13&countCSV=0%2C33%2C20%2C31%2C34%2C48%2C55%2C49%2C84%2C100%2C87%2C112%2C139%2C146%2C214%2C202%2C223%2C262%2C285%2C337%2C264%2C335%2C401%2C462%2C370%2C380%2C489%2C657%2C465%2C547%2C595%2C758%2C725%2C677%2C753%2C775%2C917%2C874%2C862%2C895%2C1064%2C1072%2C1088%2C1108%2C971%2C1085%2C1124%2C1204%2C863%2C910%2C1042%2C1172%2C&populationCSV=5241669%2C5093922%2C4808326%2C4702121%2C4969935%2C5157733%2C4998516%2C4724585%2C4464138%2C4852854%2C5060050%2C4907558%2C3950908%2C4394963%2C4795796%2C4963444%2C3236185%2C3983615%2C4334967%2C4682585%2C2646972%2C3159339%2C3857792%2C4194788%2C2276580%2C2531162%2C3000143%2C3685285%2C2136113%2C2155275%2C2384617%2C2832300%2C2153193%2C2023311%2C2038710%2C2240841%2C2022952%2C1965344%2C1885222%2C1911687%2C1767616%2C1854800%2C1808948%2C1733224%2C1424465%2C1544791%2C1633085%2C1602380%2C1051362%2C1134925%2C1265687%2C1355442%2C&uniqueId=ph2lov&description=test");
# --------
#  getApcDataJSON("key=AgeDeviations&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); 
#  getApcDataJSON("key=PerDeviations&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); 
#  getApcDataJSON("key=CohDeviations&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); 
#  getApcDataJSON("key=LongAge&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); 
# getApcDataJSON("key=CrossAge&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=Long2CrossRR&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=FittedTemporalTrends&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=PeriodRR&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=CohortRR&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=LocalDrifts&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=Coefficients&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=Waldtests&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=NetDrift&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");
# getApcDataJSON("key=Offset&title=Female%2520Pancreas%2520Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test");

# Assumes the graphs have already been created and just need to be added to Excel
# Therefore, all other keys above must have been called for this to work.
# getApcDataJSON("key=Excel&title=APC%20Analysis%20-%20%20Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); # Does not produce graph#
#APC Analysis - 
# getApcDataJSON("key=RawData&title=APdddC%20Analysis%20-%20%20Cancer&startYear=1993&startAge=33&interval=year4&periodCount=4&rowCount=14&countCSV=461%2C520%2C559%2C627%2C1065%2C1217%2C1323%2C1512%2C2160%2C2554%2C2707%2C3000%2C3495%2C4163%2C4927%2C5237%2C4785%2C5559%2C6490%2C7559%2C5106%2C6358%2C6824%2C7980%2C4873%2C6715%2C7038%2C8156%2C4863%2C6460%2C7244%2C9161%2C5237%2C6176%2C6531%2C9068%2C5628%2C5983%2C5871%2C7951%2C6060%2C6089%2C5520%2C6627%2C5722%2C6099%2C5586%2C5822%2C4185%2C4909%2C5053%2C5273%2C5227%2C6077%2C6681%2C7977%2C&populationCSV=5059030%2C4881390%2C4592280%2C4522470%2C5235420%2C4974730%2C4803820%2C4594620%2C5009550%2C5121610%2C4885700%2C4747800%2C4568930%2C4932280%2C5016980%2C4796880%2C4069220%2C4496530%2C4834800%2C4943780%2C3363020%2C4088640%2C4403470%2C4758850%2C2748540%2C3288620%2C3966000%2C4324500%2C2277930%2C2602620%2C3136830%2C3819230%2C2100130%2C2174230%2C2466900%2C3011310%2C2078240%2C1971090%2C2051330%2C2345100%2C1955640%2C1912020%2C1838950%2C1920210%2C1762440%2C1805430%2C1730210%2C1664750%2C1377240%2C1509560%2C1561980%2C1511610%2C2147130%2C2343580%2C2580260%2C2826770%2C&uniqueId=12344343334dska3&description=test"); 